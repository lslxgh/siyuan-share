# 插件配置说明

## 概述

本插件已修改为使用真实配置请求后端 API，以下是配置步骤和说明。

## 配置项

插件需要配置三个重要参数：

### 1. 服务端地址 (Server URL)
- **用途**: 后端分享服务的地址
- **示例**: `https://share.example.com`
- **说明**: 用于创建和管理分享的后端 API 服务

### 2. API Token
- **用途**: 后端服务的认证令牌
- **说明**: 用于认证访问后端分享 API
- **获取方式**: 
  1. 启动后端服务
  2. 运行 `backend/api/tools/create_user.go` 创建用户
  3. 使用生成的 API Token

### 3. 思源内核 Token (SiYuan Kernel Token)
- **用途**: 思源笔记内部 API 的认证令牌
- **说明**: 
  - 用于导出文档内容等内部操作
  - 思源笔记的所有 HTTP API 都需要此 Token 认证
  - 这是官方推荐的安全访问方式
- **为什么需要**: 
  1. 插件需要调用 `/api/export/exportMdContent` 导出文档内容
  2. 确保只有授权的程序才能访问笔记数据
  3. 使用官方 API 保证数据一致性和完整性
- **获取方式**: 
  1. 打开思源笔记
  2. 进入 `设置` -> `关于` -> `API Token`
  3. 复制该 Token

## 配置步骤

1. 在思源笔记中安装并启动本插件
2. 点击顶部菜单栏的 `设置` 图标
3. 找到 `思源在线分享` 插件设置项
4. 填写以上三个配置项：
   - 服务端地址
   - API Token
   - 思源内核 Token
5. 点击 `测试连接` 按钮验证配置
6. 点击 `保存` 按钮

## 测试连接功能

配置完成后，**强烈建议**先点击 `测试连接` 按钮进行验证：

### 测试内容

1. **后端 API Token 验证**:
   - 调用 `/api/health` 端点（需要认证）
   - **验证 Token 有效性**: 如果 Token 无效,会返回 401 错误
   - 检查网络连接是否正常
   - 成功时显示: ✅ 后端 API 正常 (用户: xxx)
   - 失败时显示具体错误原因

2. **思源内核 API Token 验证**:
   - 调用 `/api/system/version` 端点（需要认证）
   - **验证 Token 有效性**: 如果 Token 无效,会返回 401 错误
   - 检查是否能正常访问思源内部 API
   - 成功时显示: ✅ 思源内核 API 正常 (版本: xxx)
   - 失败时显示具体错误原因

### 测试特性

- **实时验证**: 使用当前输入框的值进行测试,无需先保存
- **详细反馈**: 每项测试都会显示成功 ✅ 或失败 ❌ 及具体原因
- **错误诊断**: 
  - Token 无效会明确提示 "Token 无效或未授权"
  - 网络错误会显示具体的错误信息
  - HTTP 状态码错误会显示状态码和错误详情

### 常见错误及解决方法

| 错误提示 | 可能原因 | 解决方法 |
|---------|---------|---------|
| Token 无效或未授权 | API Token 错误 | 重新生成 API Token 并填入 |
| HTTP 401 | Token 过期或无效 | 检查 Token 是否正确复制 |
| 网络请求失败 | 服务端地址错误或网络问题 | 检查服务端地址是否正确,确认网络连接 |
| 配置缺失 | 某个配置项未填写 | 填写所有必需的配置项 |

## 使用说明

配置完成后，您可以：

1. **通过文档树菜单分享**:
   - 右键点击文档树中的文档
   - 选择 `分享此文档`

2. **通过顶栏分享按钮**:
   - 打开要分享的文档
   - 点击顶栏的分享图标

3. **分享选项**:
   - 是否需要访问密码
   - 设置有效期（天数）
   - 是否公开分享

## API 调用流程

1. **导出文档内容**:
   - 使用 `思源内核 Token` 调用 `/api/export/exportMdContent`
   - 获取文档的 Markdown 内容

2. **创建分享**:
   - 使用 `API Token` 调用后端 `/api/share/create`
   - 传递文档内容、标题、密码等信息
   - 后端返回分享 ID 和分享链接

3. **本地记录**:
   - 将分享记录保存到插件的本地存储
   - 支持后续查看和管理

## 注意事项

1. **Token 安全**:
   - 所有 Token 仅保存在本地
   - 不会上传到云端或其他地方
   - 建议定期更换 Token

2. **网络要求**:
   - 需要能够访问配置的后端服务地址
   - 导出文档时需要思源内核 API 可用

3. **配置验证**:
   - 三个配置项都必须填写
   - 否则创建分享时会提示错误

## 后端服务

后端服务位于 `backend/api` 目录，详细信息请参考：
- [后端 API 文档](backend/api/README.md)
- [启动脚本](backend/start.bat) (Windows)
- [启动脚本](backend/start.sh) (Linux/Mac)

## 故障排查

### 导出文档失败
- 检查思源内核 Token 是否正确
- 确认文档 ID 是否有效
- 查看浏览器控制台错误信息

### 创建分享失败
- 检查服务端地址是否可访问
- 确认 API Token 是否有效
- 检查后端服务是否正常运行
- 查看后端日志获取详细错误

### 网络请求失败
- 检查网络连接
- 确认后端服务地址格式正确
- 检查是否有防火墙或代理阻止连接

## 更新日志

### 2025-11-07
- ✅ 添加思源内核 Token 配置项
- ✅ 修改导出文档逻辑，使用真实的思源 API
- ✅ 完善配置验证和错误提示
- ✅ 优化 API 调用流程和错误处理
- ✅ 添加测试连接功能，验证后端 API 和思源内核 API
